trigger: none
pr: none

pool:
  name: Default

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Debug'

steps:
##############################
# Step 1: Install NuGet Tool #
##############################
- task: NuGetToolInstaller@1
  displayName: 'Install NuGet Tool (1/11)'
  inputs:
    versionSpec: 
    checkLatest: true

##################################
# Step 2: Restore NuGet Packages #
##################################
- task: NuGetCommand@2
  displayName: 'Restore NuGet Packages (2/11)'
  inputs:
    restoreSolution: '$(solution)'

##########################
# Step 3: Build Solution #
##########################
- task: VSBuild@1
  displayName: 'Build Solution (3/11)'
  inputs:
    solution: '$(solution)'
    vsVersion: '17.0'
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'
    maximumCpuCount: true
    msbuildArchitecture: 'x64'
    createLogFile: true
    logFileVerbosity: 'detailed'

#################################################
# Set Short Commit ID from Build.SourceVersion #
################################################
- task: CmdLine@2
  displayName: 'Set Short Commit ID (4/11)'
  name: SetShortCommit
  inputs:
    script: |
      @echo off
      rem Get the full commit ID from the environment variable
      set "FULL_COMMIT=%BUILD_SOURCEVERSION%"
      rem Extract the first 7 characters as the short commit ID
      set "SHORT_COMMIT=%FULL_COMMIT:~0,7%"
      echo Short commit is: %SHORT_COMMIT%
      echo ##vso[task.setvariable variable=shortCommit;isOutput=true]%SHORT_COMMIT%

#################################################
# Step 4: Archive Files to ZIP (ArchiveFiles@2) #
#################################################
- task: ArchiveFiles@2
  displayName: 'Archive bin Folder to ZIP (4/11)'
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)\bin'
    includeRootFolder: true
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/Build_$(SetShortCommit.shortCommit).zip'
    replaceExistingArchive: true
    verbose: true

###################################
# Step 5: Calculate ZIP File Hash #
###################################
- task: CmdLine@2
  displayName: 'Calculate ZIP File Hash (5/11)'
  inputs:
    script: |
      @echo off
      setlocal EnableDelayedExpansion
      rem Use the short commit from the output variable
      set "SHORT_COMMIT=$(SetShortCommit.shortCommit)"
      set "ZIP_PATH=$(Build.ArtifactStagingDirectory)\Build_%SHORT_COMMIT%.zip"
      echo Calculating SHA-256 hash for ZIP file: %ZIP_PATH%
      for /F "skip=1 tokens=1" %%Z in ('certutil -hashfile "%ZIP_PATH%" SHA256 ^| findstr /V "CertUtil"') do (
          set "ZIP_HASH=%%Z"
          goto :gotHash
      )
      :gotHash
      echo ZIP file hash: !ZIP_HASH!
      rem Create a hash file in the artifact staging directory with the short commit on the first line
      echo %SHORT_COMMIT% > "$(Build.ArtifactStagingDirectory)\Build_%SHORT_COMMIT%_hashes.txt"
      echo !ZIP_HASH! >> "$(Build.ArtifactStagingDirectory)\Build_%SHORT_COMMIT%_hashes.txt"
      endlocal
      echo Hash calculation completed.

#######################################################
# Step 6: Push NuGet Packages to Azure Artifacts Feed #
#######################################################
- task: NuGetCommand@2
  displayName: 'Push NuGet Packages to Azure Artifacts (6/11)'
  inputs:
    command: 'push'
    packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
    nuGetFeedType: 'internal'
    publishVstsFeed: '4a801188-824e-4a83-b4e5-7fdcc78c6c71/05698a6e-affb-4164-b5f8-c68b8e1a2c92'
    allowPackageConflicts: true

############################################################
# Step 7: Publish Build Artifacts (Pipeline Output Folder) #
############################################################
- task: PublishBuildArtifacts@1
  displayName: 'Publish Build Artifacts (Pipeline Folder) (7/11)'
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'

###################################################
# Step 8: Create GitHub Release (Pre-release Tag) #
###################################################
- task: GitHubRelease@1
  inputs:
    gitHubConnection: 'zombi-dev-org'
    repositoryName: '$(Build.Repository.Name)'
    action: 'create'
    target: '$(Build.SourceVersion)'
    tagSource: 'userSpecifiedTag'
    tag: 'Commits - latest'
    title: 'Commit $(SetShortCommit.shortCommit)'
    assets: '$(Build.ArtifactStagingDirectory)/**/*'
    isPreRelease: true
    changeLogCompareToRelease: 'lastNonDraftReleaseByTag'
    changeLogCompareToReleaseTag: 'Commits - latest'
    changeLogType: 'commitBased'

#######################################################
# Step 9: Publish Pipeline Artifact (Build Workspace) #
#######################################################
- task: PublishPipelineArtifact@1
  displayName: 'Publish Pipeline Artifact (9/11)'
  inputs:
    targetPath: '$(Pipeline.Workspace)'
    artifact: '$(Build.SourceVersion) - $(Build.BuildId)'
    publishLocation: 'pipeline'

################################################################
# Step 10: Update README.md with Build Info and Commit Changes #
################################################################
- task: CmdLine@2
  displayName: 'Update README.md with Build Info (10/11)'
  inputs:
    script: |
      @echo off
      echo Updating README.md with dynamic build information...
      
      rem Use the short commit from the output variable
      set "SHORT_COMMIT=$(SetShortCommit.shortCommit)"
      set "COMMIT_LINK=https://github.com/zombi-dev-org/Project-Multiground/commit/%SHORT_COMMIT%"
      set "ARTIFACT_LINK=https://github.com/zombi-dev-org/Project-Multiground/actions/runs/$(Build.BuildId)"
      set "RELEASE_LINK=https://github.com/zombi-dev-org/Project-Multiground/releases/tag/Pre-release"
      
      rem Use PowerShell inline commands to update README.md placeholders
      powershell -Command "(Get-Content README.md) -replace '\[\[latest commit ID\]\]', '%SHORT_COMMIT%' | Set-Content README.md"
      powershell -Command "(Get-Content README.md) -replace '\[\[latest commit link\]\]', '%COMMIT_LINK%' | Set-Content README.md"
      powershell -Command "(Get-Content README.md) -replace '\[\[latest commit artifact''s link\]\]', '%ARTIFACT_LINK%' | Set-Content README.md"
      powershell -Command "(Get-Content README.md) -replace '\[\[latest commit release link\]\]', '%RELEASE_LINK%' | Set-Content README.md"
      
      echo Checking out branch: $(Build.SourceBranchName)
      git checkout $(Build.SourceBranchName)
      
      rem Use built-in variables for email and user
      set "EMAIL=$(Build.RequestedForEmail)"
      set "USER=$(Build.RequestedFor)"
      
      echo Configuring git with email: %EMAIL% and user: %USER%
      git config --global user.email "%EMAIL%"
      git config --global user.name "%USER%"
      
      git add README.md
      git commit -m "Update README.md for %SHORT_COMMIT%"
      git push origin $(Build.SourceBranchName)
      
      echo README.md updated and changes pushed.
      echo Done!
